# Instructions for the generation of *apo* site pharmacophores by the [Apo2ph4](https://pubs.acs.org/doi/10.1021/acs.jcim.2c00814) algorithm

**Requirements**

- Python 3
- CDPKit python bindings <https://github.com/molinfo-vienna/CDPKit>\
- scikit-learn python package
- Pymol python bindings (e.g. <https://pymol.org/conda/>)
- MGLTools (1.5.6 or newer) (<https://ccsb.scripps.edu/mgltools/downloads/>)
- OpenBabel (<http://openbabel.org/wiki/Main_Page>)
- KNIME (4.1.2 or newer, <https://www.knime.com/downloads>)
- LigandScout KNIME exensions (available as a KNIME Partner extension)
- AutoDock4 including AutoGrid4 (<https://autodock.scripps.edu/download-autodock4/>)
- AutoDock Vina (<https://vina.scripps.edu/downloads/>)

**Required to be accessible via the *$PATH* environment variable:**

- MGLTools Utilities
- OpenBabel
- KNIME
- AutoDock4
- AutoDock Vina

**Recommended way to install required packages:**

The easiest and recommended way to obtain and install most of the
packages required to run *Apo2ph4* is to create a dedicated conda
environment and perform the package installation as follows:

```console
conda create apo2ph4 python==3.10
conda acivate apo2ph4
pip install cdpkit
pip install scikit-learn
conda install pymol-open-source
conda install openbabel
conda install bioconda::autodock
conda install autodock-vina
conda install mgltools
```

### Quickstart guide

The workflow comprises three steps (scripts) where one of them is
optional. If desired, these scripts may be executed in succession using
a bash script to require no intervention after a binding pocket is
selected.

**1\) apo2ph4\_define\_binding\_site.py** (Optional)

If a binding site is defined by specifying cartesian coordinates
`apo2ph4_define_binding_site.py` must be run beforehand. It takes
one PDB file and the x, y and z coordinates as positional arguments. This
script removes all ligands, ions, and solvent molecule before placing a
dummy molecule at the defined coordinates.

For example:

```console
apo2ph4_define_binding_site.py [protein].pdb 141.021 55.154 89.114
```
This generates *\[protein\]\_prepared.pdb* in the same folder as the
input PDB.

This file may also be opened in LigandScout which now recognizes the
binding site due to placement of the dummy molecule.

**2\) apo2ph4\_prepare\_and\_dock.sh**

The second part of the workflow is a bash script that takes two
positional arguments, for example:

```console
sh apo2ph4_prepare_and_dock.sh [fragment_library].sdf [protein]_prepared.pdb
```
*\[fragment\_library\].sdf* should contain the fragment database with
3D-coordinates in SDF format (this database may for example be prepared
by energy minimizing a fragment library lacking 3D coordinates in
*LigandScout* and then saving it in SDF format or one can use the file
*fragments.sdf* located in the *data* directory).

*\[protein\]\_prepared.pdb* was either prepared beforehand (step 1) or
should be a PDB file only containing a single ligand that defines the
binding site (other ligands, ions and solvent molecules must be
removed). The script should ideally be called from the directory that
contains the PDB file .

The script generates a combined *LigandScout* \*.pml file as
*./pharmacophores/pharmacophores.pml* in the current working
directory. The necessary grid energy files are placed in the parent
folder as \*.map (e.g. *receptor.C.map*) files which also contains the
*feature\_count.txt* file required for subsequent steps.

**Notes:**

It should be noted that *KNIME* will be executed in batch mode with pre-set
memory parameters. If not enough resources are available or for optimal
performance the following parameters of the last line of
`apo2ph4_prepare_and_dock.sh` should be modified: *-vmargs
-Xmx32000m -Xms10048m*

*-Xmx32000m* defines the maximum available memory (in this case 32 GB) and
*-Xms10048m* defines the initial memory reserved (in this case 10 GB)

Intermediate files such as docked poses, mock ligand/protein complexes
are stored in directory *./tempdock* .

Contents of *./tempdock* are not required for subsequent steps and
get only saved for debugging purposes. As this occupies a lot of space
(~500 MB for 200 fragments) it is recommended that a `rm -rf ./tempdock`
is added to the end of the script should these files not
be desired.

*Vina* docking parameters are hardcoded, these may be changed by modifying
the `write_vina_conf.py` file in the workflow *scripts*
directory

**3\) apo2ph4\_generate\_ph4.py**

The last step of the workflow generates a final pharmacophore model and
requires the *pharmacophores.pml*, *grid map* and
*feature\_count.txt* files generated by the previous step.

The number of pharmacophore features, energy thresholds as well as other
settings may be specified by optional parameters.

Execute `apo2ph4_generate_ph4.py -h` to see all available parameters
for advanced usage.

*Basic example (mandatory arguments only):*

```console
apo2ph4_generate_ph4.py -i pharmacophores.pml -o my_ph4.pml -g ../
```
*Advanced example:*

```console
apo2ph4_generate_ph4.py -i pharmacophores.pml -o my_ph4.pml -g ../ -n 8 --name "my pharmacophore model" -H 5 --H_energy -0.6 -v
```
It is recommended to examine the final pharmacophore model visually by
means of *LigandScout* to make sure no features have been placed outside
the actual binding pocket.
